<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Art Frenzy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fff;
            color: #000;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: black;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .product-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            background: #fff;
        }
        .product-card img {
            max-width: 100%;
            height: auto;
        }
        button {
            background: black;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            max-width: 400px;
            width: 100%;
        }
        .faq-link {
            display: block;
            margin: 1rem auto;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>Art Frenzy</h1>
    </header>

    <div class="faq-link">
        <a href="https://wa.me/254700000000" target="_blank">Need Help? Chat with us on WhatsApp</a>
    </div>

    <div class="products" id="products"></div>

    <div class="modal" id="orderModal">
        <div class="modal-content">
            <h2>Complete Your Order</h2>
            <form id="orderForm">
                <input type="hidden" id="selectedProductId" />
                <label>Name:</label>
                <input type="text" id="buyerName" required><br><br>
                <label>Phone:</label>
                <input type="tel" id="buyerPhone" required><br><br>
                <label>Drop-off Location:</label>
                <input type="text" id="dropLocation" required><br><br>
                <label>M-Pesa Transaction ID:</label>
                <input type="text" id="transactionId" required><br><br>
                <button type="submit">Place Order</button>
            </form>
        </div>
    </div>

    <script>
        const apiBase = "https://art-frenzy-admin-3.onrender.com";
        const productsContainer = document.getElementById("products");
        const orderModal = document.getElementById("orderModal");
        const orderForm = document.getElementById("orderForm");
        const selectedProductId = document.getElementById("selectedProductId");

        // Fetch and display products
        async function loadProducts() {
            const res = await fetch(`${apiBase}/products`);
            const products = await res.json();
            productsContainer.innerHTML = "";
            products.forEach(p => {
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <img src="${p.image_url}" alt="${p.title}" />
                    <h3>${p.title}</h3>
                    <p>KES ${p.price}</p>
                    <p>Stock: ${p.stock}</p>
                    <button onclick="openOrderModal(${p.id})">Order</button>
                `;
                productsContainer.appendChild(card);
            });
        }

        function openOrderModal(productId) {
            selectedProductId.value = productId;
            orderModal.style.display = "flex";
        }

        orderModal.addEventListener("click", e => {
            if (e.target === orderModal) orderModal.style.display = "none";
        });

        // Handle order form submission
        orderForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                product_id: selectedProductId.value,
                name: document.getElementById("buyerName").value,
                phone: document.getElementById("buyerPhone").value,
                drop_location: document.getElementById("dropLocation").value,
                transaction_id: document.getElementById("transactionId").value
            };
            const res = await fetch(`${apiBase}/orders`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert("Order placed successfully!");
                orderModal.style.display = "none";
            } else {
                alert("Failed to place order.");
            }
        });

        // Shorten image filename before upload
        function shortenFileName(file) {
            const ext = file.name.split('.').pop();
            const newName = Date.now() + '.' + ext;
            return new File([file], newName, { type: file.type });
        }

        loadProducts();
    </script>
</body>
</html>
